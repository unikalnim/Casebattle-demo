<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Case Battle — Главная</title>
  <style>
    :root { --sidebar-width: 182px; }

    body {
      margin: 0;
      color: #fff;
      background-image:url(bg_case.webp);
      background-size: 1300px 300px;
      background-color: #171c25;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
      background-position: center;
      background-position-x: 460px;
      background-position-y: 80px;
    }

    header {
      position: fixed;
      width: var(--sidebar-width);
      height: 100vh;
      background: #13171f;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      z-index: 1000;
    }

    header img.logo {
      height: 62px;
      margin-top: 2px;
    }

    .topbar {
      position: relative;
      background: #13171f;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 25px;
      gap: 50px;
      margin-left: var(--sidebar-width);
    }

    .topbar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #ffffff;
      transition: transform 0.2s ease, filter 0.2s ease;
    }

    .topbar-item img { width: 30px; height: 30px; }
    .topbar-item span { font-size: 11px; margin-top: 5px; }

    .topbar-item:hover {
      transform: translateY(-2px);
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
    }

    .user-info {
      display: none;
      align-items: center;
      gap: 12px;
      background: none;
      color: white;
    }

    .user-info img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 2px solid #f07a3f;
      object-fit: cover;
    }

    .user-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
      line-height: 1.1;
      font-size: 12px;
      font-weight: 400;
    }

    .hello-text {
      color: #f07a3f;
      font-weight: 500;
      font-size: 12px;
    }

    .nickname {
      color: #ffffff;
      font-size: 13px;
      font-weight: 500;
    }

    .balance-text {
      color: #ffffff;
      font-size: 11px;
      font-weight: 400;
    }

    .balance-amount {
      color: #f07a3f;
      font-weight: 500;
      font-size: 12px;
    }

    .auth-btn, .user-info {
      margin-left: auto;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .auth-btn {
      background-color: #f07a3f;
      color: #fff;
      border: none;
      transition: background 0.3s;
    }
    .auth-btn:hover { background-color: #ff8b55; }

    main {
      padding: 50px;
      margin-left: 190px;
      margin-top: 37px;
    }

    .profile-center {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 60vh;
    }

    .profile-box {
      width: 350px;
      background: rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      border-radius: 10px;
      overflow: hidden;
      padding-bottom: 20px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid #f07a3f;
      object-fit: cover;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .profile-name {
      color: #fff;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .profile-balance {
      color: #ffffff;
      font-size: 17px;
      font-weight: 700;
      margin-left: -200px;
      margin-top: -25px;
    }

    .profile-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      box-sizing: border-box;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .profile-username-top {
      font-weight: 500;
      font-size: 14px;
      color: #f07a3f;
    }

    .profile-settings {
      font-size: 18px;
      cursor: pointer;
      transition: 0.2s;
    }

    .profile-settings:hover { transform: rotate(30deg); }

    .replenish-btn {
      margin-top: 15px;
      background-color: #522b17;
      color: #ffffff;
      padding: 8px 20px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      border:solid;
      border-color: #ff732e;
    }

    .replenish-btn:hover { background-color: #ff7300; }

    .promo-message {
      font-size: 12px;
      margin-top: 5px;
      height: 16px;
      color: #f07a3f;
    }

    .balimgg{
      height: 35px;
      margin-right: 300px;
    }
  </style>
</head>
<body>

  <header>
    <a href="index.html"><img src="Screenshot (5).png" alt="logo" class="logo"></a>
  </header>

  <div class="topbar">
    <a href="#" class="topbar-item"><img src="upgrade-icon.svg" alt=""><span>АПГРЕЙД</span></a>
    <a href="#" class="topbar-item"><img src="contract-icon.svg" alt=""><span>КОНТРАКТ</span></a>
    <a href="#" class="topbar-item"><img src="giveaway-icon.svg" alt=""><span>РОЗЫГРЫШ</span></a>
    <a href="#" class="topbar-item"><img src="medal.svg" alt=""><span>ТУРНИР</span></a>
    <a href="admin.html" class="topbar-item"><img src="ico-profile-success.png" alt=""><span>ADMIN</span></a>
    
    <button class="auth-btn" id="loginBtn">Войти с Google</button>

    <div class="user-info" id="userInfo">
      <a href="profile.html"><img id="userPhoto" src="" alt="Профиль"></a>
      <div class="user-text">
        <span class="hello-text">Привет,</span>
        <span id="usernameDisplay" class="nickname"></span>
        <span class="balance-text">на счете <span id="balanceDisplay" class="balance-amount">0.00 ₽</span></span>
      </div>
    </div>
  </div>

  <main>
    <h1 style="text-align:center; font-weight:300; font-size: 24px;">ПРОФИЛЬ</h1>

    <div class="profile-center">
      <div class="profile-box">
        <div class="profile-header">
          <span id="profileUsernameTop" class="profile-username-top">Arlert</span>
          <div class="profile-settings">⚙️</div>
        </div>

        <img id="profilePhoto" src="default-avatar.png" alt="Аватар" class="profile-avatar">
        <p id="profileName" class="profile-name">Имя пользователя</p>
        <img id="balimg" src="wallet.png" alt="" class="balimgg">
        <p class="profile-balance"><span id="balanceDisplayBox">0.00 ₽</span></p>

        <!-- Кнопка и ввод промокода -->
        <input type="text" id="promoInput" placeholder="Введите промокод" style="margin-top:15px; padding:6px 10px;background-color: #13171f;color: white; text-align:center; outline:none; width:180px;">
        <button class="replenish-btn" id="applyPromoBtn">Получить</button>
        <p class="promo-message" id="promoMessage"></p>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDn_hZA2IuN9pKDSLnFcdTXfreRBrtfQ2M",
      authDomain: "case-battle-af897.firebaseapp.com",
      projectId: "case-battle-af897",
      storageBucket: "case-battle-af897.firebasestorage.app",
      messagingSenderId: "485044842847",
      appId: "1:485044842847:web:869c6e455b9d781ab9c6ea",
      measurementId: "G-N3P3CK60GB"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    document.getElementById("loginBtn").addEventListener("click", async () => {
      try { await auth.signInWithPopup(provider); }
      catch (error) { alert("Ошибка входа: " + error.message); }
    });

    auth.onAuthStateChanged(async (user) => {
      const loginBtn = document.getElementById("loginBtn");
      const userInfo = document.getElementById("userInfo");
      const usernameDisplay = document.getElementById("usernameDisplay");
      const userPhoto = document.getElementById("userPhoto");
      const profileName = document.getElementById("profileName");
      const profilePhoto = document.getElementById("profilePhoto");
      const balanceDisplay = document.getElementById("balanceDisplay");
      const balanceDisplayBox = document.getElementById("balanceDisplayBox");
      const profileUsernameTop = document.getElementById("profileUsernameTop");

      if (user) {
        loginBtn.style.display = "none";
        userInfo.style.display = "flex";

        usernameDisplay.textContent = user.displayName || "Пользователь";
        userPhoto.src = user.photoURL || "default-avatar.png";
        profileName.textContent = user.displayName || "Пользователь";
        profilePhoto.src = user.photoURL || "default-avatar.png";
        profileUsernameTop.textContent = user.displayName || "Пользователь";

        const userRef = db.collection("users").doc(user.uid);
        const docSnap = await userRef.get();

        if (!docSnap.exists) {
          await userRef.set({ name: user.displayName || "Пользователь", balance: 0 });
          balanceDisplay.textContent = "0.00 ₽";
          balanceDisplayBox.textContent = "0.00 ₽";
        } else {
          const data = docSnap.data();
          const bal = data.balance?.toFixed(2) || "0.00";
          balanceDisplay.textContent = `${bal} ₽`;
          balanceDisplayBox.textContent = `${bal} ₽`;
        }
      } else {
        loginBtn.style.display = "block";
        userInfo.style.display = "none";
      }
    });

    // === ПРОМОКОД ===
    document.getElementById("applyPromoBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const promoCode = document.getElementById("promoInput").value.trim().toUpperCase();
      const msg = document.getElementById("promoMessage");

      if (!user) return msg.textContent = "Войдите в аккаунт!";
      if (!promoCode) return msg.textContent = "Введите промокод!";

      try {
        const promoRef = db.collection("promocodes").doc(promoCode);
        const promoSnap = await promoRef.get();

        if (!promoSnap.exists) {
          msg.textContent = "Неверный промокод!";
          return;
        }

        const promoData = promoSnap.data();
        const value = promoData.value || 0;

        const userRef = db.collection("users").doc(user.uid);
        const userSnap = await userRef.get();
        let balance = userSnap.data().balance || 0;

        balance += value;
        await userRef.update({ balance });

        document.getElementById("balanceDisplay").textContent = balance.toFixed(2) + " ₽";
        document.getElementById("balanceDisplayBox").textContent = balance.toFixed(2) + " ₽";
        msg.textContent = `+${value} ₽ зачислено!`;
      } catch (err) {
        msg.textContent = "Ошибка: " + err.message;
      }
    });
  </script>
</body>
</html>
